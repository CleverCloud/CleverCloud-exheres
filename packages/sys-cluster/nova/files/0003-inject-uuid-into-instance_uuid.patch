From 093fbcbd711e7e33b925c20bee1e5aa1ea55d909 Mon Sep 17 00:00:00 2001
From: Marc-Antoine Perennou <Marc-Antoine@Perennou.com>
Date: Mon, 16 Jul 2012 15:17:10 +0200
Subject: [PATCH] inject uuid into /instance_uuid

---
 nova/virt/disk/api.py |    8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/nova/virt/disk/api.py b/nova/virt/disk/api.py
index 6cb19f2..4a58c5c 100644
--- a/nova/virt/disk/api.py
+++ b/nova/virt/disk/api.py
@@ -224,7 +224,7 @@ class _DiskImage(object):
 
 def inject_data(image,
                 key=None, net=None, metadata=None, admin_password=None,
-                partition=None, use_cow=False):
+                partition=None, use_cow=False, uuid=None):
     """Injects a ssh key and optionally net data into a disk image.
 
     it will mount the image as a fully partitioned disk and attempt to inject
@@ -238,7 +238,7 @@ def inject_data(image,
         try:
             inject_data_into_fs(img.mount_dir,
                                 key, net, metadata, admin_password,
-                                utils.execute)
+                                utils.execute, uuid)
         finally:
             img.umount()
     else:
@@ -291,7 +291,7 @@ def destroy_container(img):
         LOG.exception(_('Failed to remove container: %s'), exn)
 
 
-def inject_data_into_fs(fs, key, net, metadata, admin_password, execute):
+def inject_data_into_fs(fs, key, net, metadata, admin_password, execute, uuid):
     """Injects data into a filesystem already mounted by the caller.
     Virt connections can call this directly if they mount their fs
     in a different way to inject_data
@@ -304,6 +304,8 @@ def inject_data_into_fs(fs, key, net, metadata, admin_password, execute):
         _inject_metadata_into_fs(metadata, fs, execute=execute)
     if admin_password:
         _inject_admin_password_into_fs(admin_password, fs, execute=execute)
+    if uuid:
+        _inject_file_into_fs(fs, 'instance_uuid', uuid)
 
 
 def _inject_file_into_fs(fs, path, contents):
-- 
1.7.10.4

