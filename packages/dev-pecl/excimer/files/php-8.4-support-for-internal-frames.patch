Upstream: yes

From 05667eaac58f784f19b9d91fe41f99eb6ceddf14 Mon Sep 17 00:00:00 2001
From: Timo Tijhof <krinkle@fastmail.com>
Date: Fri, 13 Jun 2025 19:29:04 -0700
Subject: [PATCH] tests: Accomodate PHP 8.4 support for internal frames

Bug: T380748
Change-Id: I581e6711433cd48c3c83fd624ecab5644b6695e7
---
 tests/maxDepth.phpt | 61 ++++++++++++++++++++++++++++++++++++---------
 1 file changed, 49 insertions(+), 12 deletions(-)

diff --git a/tests/maxDepth.phpt b/tests/maxDepth.phpt
index e09c6e8..97fc573 100644
--- a/tests/maxDepth.phpt
+++ b/tests/maxDepth.phpt
@@ -10,24 +10,61 @@ $profiler->setEventType(EXCIMER_REAL);
 $profiler->setPeriod(0.1);
 $profiler->setMaxDepth(5);

-function foo( $depth ) {
+function quux() {
+	bar_1();
+}
+function bar_1() {
+	bar_2();
+}
+function bar_2() {
+	bar_3();
+}
+function bar_3() {
+	bar_4();
+}
+function bar_4() {
+	foo_5();
+}
+function foo_5() {
+	foo_6();
+}
+function foo_6() {
+	foo_7();
+}
+function foo_7() {
+	foo_8();
+}
+function foo_8() {
+	foo_9();
+}
+function foo_9() {
+	foo_10();
+}
+function foo_10() {
 	global $profiler;
-
-	if ( $depth > 0 ) {
-		foo( $depth - 1 );
-	} else {
-		$profiler->start();
-		while (!count($profiler->getLog())) {
-			usleep(10000);
-		}
-		$profiler->stop();
+	$profiler->start();
+	while (!count($profiler->getLog())) {
+		// 10ms toward the 0-100ms interval (random/staggered start time)
+		usleep(10000);
 	}
+	$profiler->stop();
 }

-foo( 20 );
+quux();

 $log = $profiler->flush();
 echo $log->formatCollapsed() . "\n";

+// T380748: PHP 8.1-8.3 includes one more frame than PHP 8.4+,
+// because PHP 8.4 adds support for internal frames like usleep().
+
+// php83> excimer_truncated;foo_5;foo_6;foo_7;foo_8;foo_9;foo_10
+// php84> excimer_truncated;foo_6;foo_7;foo_8;foo_9;foo_10
+//
+// We tolerate this via the "%s" wildcard.
+// Note that it is should not be in front of "foo_6" but inside of it,
+// as we must strictly assert the top-most frame to be foo (5 or 6),
+// and not bar_1 to bar_4 (which would mean the maxDepth is broken).
+
 --EXPECTF--
-excimer_truncated;foo;foo;foo;foo;foo;foo %d
+excimer_truncated;fo%s_6;foo_7;foo_8;foo_9;foo_10 %d
