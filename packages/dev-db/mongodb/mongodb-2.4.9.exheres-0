# Copyright 2012 Michael Thomas <aelmalinka@gmail.com>
# Distributed under the terms of the GNU General Public License v2
# Based in part upon 'mongodb-1.6.5.exheres-0', which is:
#    Copyright 2010 Jonathan Dahan <jedahan@gmail.com>

require scons

SUMMARY="A scalable, high-performance, schema-free, document-oriented database"
DESCRIPTION="Written in C++, MongoDB bridges the gap between key-value stores
(which are fast and highly scalable) and traditional RDBMS systems (which
provide structured schemas and powerful queries)."
HOMEPAGE="http://www.mongodb.org"
DOWNLOADS="http://downloads.mongodb.org/src/${PN}-src-r${PV}.tar.gz"

LICENCES="AGPL-3"
SLOT="0"
PLATFORMS="~amd64"

MYOPTIONS="
    (
        v8 [[ description = [ Use Google's Javascript engine v8 ] ]]
        spidermonkey [[ description = [ Use Mozilla's Javascript engine spidermonkey ] ]]
    ) [[ number-selected = exactly-one ]]
"

DEPENDENCIES="
    build:
        dev-libs/boost
    build+run:
        dev-libs/pcre
        v8? ( dev-libs/v8 )
"

WORK="${WORKBASE}/${PN}-src-r${PV}"

MONGO_PARAMS=(
    CFLAGS="${CFLAGS}"
    CXXFLAGS="${CXXFLAGS}"
    LDFLAGS="${LDFLAGS}"
    --extralib=pcre
    --use-system-pcre
    --full
)

src_prepare() {
    default
    edo sed -e 's/"-Werror", //' -i SConstruct
}

src_configure() {
    # mongodb dislikes calling scons with different flags, so store flags and re-use them
    if option v8 ; then MONGO_PARAMS+=( --usev8 ) ; fi
    if option spidermonkey ; then MONGO_PARAMS+=( --usesm ) ; fi
}

src_compile() {
    escons \
        --jobs ${EXJOBS:-1} \
        "${MONGO_PARAMS[@]}" \
        all
}

src_install() {
    escons \
        --jobs ${EXJOBS:-1} \
        --nostrip \
        --prefix="${IMAGE}"/usr \
        "${MONGO_PARAMS[@]}" \
        install

    [[ "${LIBDIR}" != "lib" ]] && edo rm -r "${IMAGE}"/usr/lib

    emagicdocs
}

src_test() {
    escons \
        --jobs ${EXJOBS:-1} \
        "${MONGO_PARAMS[@]}" \
        test

    edo ./test
}

