# Copyright 2012 Marc-Antoine Perennou <Marc-Antoine@Perennou.com>
# Distributed under the terms of the GNU General Public License v2

require googlecode [ suffix=tar.gz ] systemd-service

SUMMARY="Open source in-memory key-value store"
DESCRIPTION="
Redis is an open source, advanced key-value store. It is often referred to as a data structure
server since keys can contain strings, hashes, lists, sets and sorted sets.
"

LICENCES="redis"
SLOT="0"
PLATFORMS="~amd64"
MYOPTIONS=""

DEPENDENCIES="
test:
    dev-lang/tcl
"

DEFAULT_SRC_PREPARE_PATCHES=( "${FILES}"/9e21f82cdce4732ceb7d5ec1ad6202fe95684816.patch )

src_test() {
    esandbox allow_net --connect inet:127.0.0.1@11111
    esandbox allow_net inet:0.0.0.0@11111
    esandbox allow_net --connect inet:127.0.0.1@20000-30000
    esandbox allow_net inet:0.0.0.0@20000-30000

    emake test

    esandbox disallow_net --connect inet:127.0.0.1@11111
    esandbox disallow_net inet:0.0.0.0@11111
    esandbox disallow_net --connect inet:127.0.0.1@20000-30000
    esandbox disallow_net inet:0.0.0.0@20000-30000
}

src_install() {
    emake DESTDIR="${IMAGE}" PREFIX="/" install
    install_systemd_files
    insinto /etc
    doins redis.conf
}
