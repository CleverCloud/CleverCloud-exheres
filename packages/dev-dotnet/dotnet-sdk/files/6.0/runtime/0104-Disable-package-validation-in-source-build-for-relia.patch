From 384ee9b3962682588589a3f9ae1f267fd6767731 Mon Sep 17 00:00:00 2001
From: s0dyy <msorin@msorin.com>
Date: Mon, 13 Dec 2021 17:55:21 +0100
Subject: [PATCH] Disable package validation in source-build for reliability

---
 eng/packaging.targets | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/eng/packaging.targets b/eng/packaging.targets
index ecf74672ac8..0a04191182d 100644
--- a/eng/packaging.targets
+++ b/eng/packaging.targets
@@ -1,7 +1,13 @@
 <Project>
 
   <PropertyGroup>
-    <EnablePackageValidation>true</EnablePackageValidation>
+    <!--
+      Package validation causes flaky errors during the build. Validation isn't useful during
+      source-build (it is only a guardrail for devs), so disable it during source-build to avoid the
+      impact on build reliability. https://github.com/dotnet/runtime/issues/60883 tracks fixing the
+      flakiness and removing this condition.
+    -->
+    <EnablePackageValidation Condition="'$(DotNetBuildFromSource)' != 'true'">true</EnablePackageValidation>
     <!-- Don't restore prebuilt packages during sourcebuild. -->
     <DisablePackageBaselineValidation Condition="'$(DotNetBuildFromSource)' == 'true'">true</DisablePackageBaselineValidation>
     <PackageValidationBaselineVersion Condition="'$(PackageValidationBaselineVersion)' == ''">$([MSBuild]::Subtract($(MajorVersion), 1)).0.0</PackageValidationBaselineVersion>
-- 
2.34.1

